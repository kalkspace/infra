---
- hosts: localhost
  gather_facts: false
  vars:
    container_name: "ansible-test-{{ '' | to_uuid }}"
  tasks:
    - name: Build test container
      community.docker.docker_image:
        build:
          path: ./test-env
        name: kalkspace-infra-test-env
        source: build
        # needed to get the image id
        force_source: true
      register: test_env

    - name: Bring up docker container
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ test_env.image.Id }}"
        command: ["sleep", "infinity"]
        detach: true
        recreate: true
        force_kill: true
        container_default_behavior: "no_defaults"

    - name: Add to inventory
      add_host:
        name: "{{ container_name }}"
        groups: docker_test
        ansible_connection: community.docker.docker

- hosts: docker_test
  roles:
    - metrics
